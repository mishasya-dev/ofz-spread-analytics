# OFZ Spread Analytics - Журнал работы

## v0.2.2 — Оптимизация (27.02.2026)

### Найденные и исправленные проблемы

| # | Проблема | Решение |
|---|----------|---------|
| 1 | `FutureWarning: 'H' is deprecated` | `freq='H'` → `freq='h'` |
| 2 | Пустой `except:` без логирования | `(ValueError, TypeError)` с логированием |
| 3 | **Медленный MOEX API (30+ сек)** | Пакетный запрос `fetch_all_market_data()` |
| 4 | `LASTTRADEDATE` недоступна | Используем `NUMTRADES` / `VALTODAY` |
| 5 | Дубли облигаций | `seen_isins` для удаления |
| 6 | O(n²) расчёт спредов | Убран — спреды на лету |

### Оптимизация MOEX API

**До:**
```
fetch_ofz_only() - много запросов
fetch_market_data(isin) - N запросов
LASTTRADEDATE - не работает
```

**После:**
```
fetch_ofz_only() - 1 запрос
fetch_all_market_data() - 1 запрос для всех
NUMTRADES, VALTODAY - работают
```

**Результат:** ~1.7 сек для 33 ОФЗ (было 30+ сек)

### Intraday улучшения

| Интервал | Было | Стало |
|----------|------|-------|
| 1 минута | 3 дня | 3 дня |
| 10 минут | 30 дней | 30 дней |
| **1 час** | **30 дней** | **365 дней** |

Пагинация работает: ~6 сек для 4000+ часовых свечей.

### Удаление лишнего

- **Расчёт спредов при обновлении БД** — убран
- Спреды рассчитываются на лету: `spread = (YTM1 - YTM2) × 100`
- Для 64 облигаций: 2016 расчётов → 0

### Тесты

```
tests/run_tests.py:    38/38 ✅
tests/test_database.py: 38/38 ✅
tests/test_sidebar.py:  14/14 ✅
────────────────────────────────
Итого:                  90/90 ✅
```

---

## v0.2.0 — Динамическое управление (27.02.2026)

### Реализовано

- Таблица `bonds` в SQLite
- Модальное окно `@st.dialog` для управления
- Фильтрация: ОФЗ-ПД, > 0.5 года, торги за 10 дней
- `is_favorite` для избранного
- Миграция 16 облигаций из config.py

### Файлы

- `components/bond_manager.py` — модальное окно
- `api/moex_bonds.py` — получение облигаций с MOEX
- `tests/test_sidebar.py` — 14 новых тестов

---

## v0.1.0 — Базовая версия (26.02.2026)

### Реализовано

- SQLite БД (daily_ytm, intraday_ytm, spreads)
- Два режима: daily и intraday
- Расчёт YTM из цен свечей
- Торговые сигналы
- 76 тестов

---

*Последнее обновление: 27.02.2026*
