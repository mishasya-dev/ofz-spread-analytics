# MOEX API Documentation

Документация по работе с API Московской биржи (MOEX ISS API).

## Базовый URL

```
https://iss.moex.com/iss
```

---

## Интервалы свечей

### Эндпоинт

```
/engines/stock/markets/bonds/boards/TQOB/securities/{SECID}/candles.json
```

### Параметры

| Параметр | Описание | Пример |
|----------|----------|--------|
| `from` | Начальная дата | `2026-01-01` |
| `till` | Конечная дата | `2026-01-31` |
| `interval` | Интервал свечи | `1`, `10`, `60` |
| `start` | Смещение для пагинации | `0`, `500`, `1000` |
| `iss.meta` | Отключить метаданные | `off` |

### Поддерживаемые интервалы

**Для ОФЗ MOEX API поддерживает только 4 интервала:**

| Интервал | Значение | Максимум дней | Свечей в день* |
|----------|----------|---------------|----------------|
| 1 минута | `1` | 3 дня | ~100 |
| 10 минут | `10` | 30 дней (реально 90+) | ~100 |
| 1 час | `60` | 365 дней | ~17 |
| 1 день | `24` | 365+ дней | 1 |

*Количество свечей зависит от торговой сессии (основная + вечерняя).

### ❌ НЕ поддерживаемые интервалы

MOEX API для ОФЗ **не поддерживает** следующие интервалы (протестировано 01.03.2026):

| Интервал | Статус |
|----------|--------|
| 2, 3, 5 минут | ❌ Нет данных |
| 15, 20, 30 минут | ❌ Нет данных |
| 2, 3, 4, 6, 8 часов | ❌ Нет данных |
| Неделя (`W`), Месяц (`M`) | ❌ Возвращает некорректные данные |

### Пагинация

MOEX API возвращает максимум **500 свечей на один запрос**. Для получения большего количества данных используйте пагинацию:

```python
all_candles = []
start = 0
batch_size = 500

while True:
    params = {
        'from': start_date.isoformat(),
        'till': end_date.isoformat(),
        'interval': '10',
        'start': start,
        'iss.meta': 'off'
    }
    
    response = requests.get(url, params=params)
    data = response.json()
    rows = data.get('candles', {}).get('data', [])
    
    if not rows:
        break
    
    all_candles.extend(rows)
    
    if len(rows) < batch_size:
        break
    
    start += batch_size
```

### Реальные ограничения (протестировано 01.03.2026)

| Интервал | Период | Свечей | Торговых дней | Статус |
|----------|--------|--------|---------------|--------|
| 10 минут | 30 дней | ~2,000 | 20 | ✅ Работает |
| 10 минут | 60 дней | ~3,700 | 38 | ✅ Работает |
| 10 минут | 90 дней | ~5,900 | 60 | ✅ Работает |
| 1 час | 365 дней | ~4,000 | ~250 | ✅ Работает |

### Возвращаемые колонки

```python
['open', 'close', 'high', 'low', 'value', 'volume', 'begin', 'end']
```

| Колонка | Описание | Тип |
|---------|----------|-----|
| `open` | Цена открытия | float |
| `close` | Цена закрытия | float |
| `high` | Максимальная цена | float |
| `low` | Минимальная цена | float |
| `value` | Объём в рублях | float |
| `volume` | Количество сделок | int |
| `begin` | Время начала свечи | datetime |
| `end` | Время конца свечи | datetime |

---

## Исторические YTM (YIELDCLOSE)

### Эндпоинт

```
/history/engines/stock/markets/bonds/securities/{SECID}.json
```

### Параметры

| Параметр | Описание | Пример |
|----------|----------|--------|
| `from` | Начальная дата | `2026-01-01` |
| `till` | Конечная дата | `2026-01-31` |
| `iss.meta` | Отключить метаданные | `off` |

### Возвращаемые колонки (ключевые)

| Колонка | Описание | Тип |
|---------|----------|-----|
| `TRADEDATE` | Дата торгов | date |
| `CLOSE` | Цена закрытия | float |
| `YIELDCLOSE` | Доходность к погашению | float |
| `DURATION` | Дюрация в днях | int |

---

## Рыночные данные

### Эндпоинт

```
/engines/stock/markets/bonds/securities/{SECID}.json
```

### Возвращаемые данные (marketdata)

| Колонка | Описание | Тип |
|---------|----------|-----|
| `YIELD` | Текущая доходность | float |
| `DURATION` | Дюрация в днях | int |
| `MARKETPRICE` | Рыночная цена | float |
| `NUMTRADES` | Количество сделок | int |

### Пакетный запрос

```
/engines/stock/markets/bonds/securities.json
```

Возвращает данные по всем облигациям одним запросом.

---

## Идентификаторы облигаций

### ISIN vs SECID

MOEX использует два типа идентификаторов:

| Тип | Пример | Использование |
|-----|--------|---------------|
| **SECID** | `SU26221RMFS0` | Для запросов к API |
| **ISIN** | `RU00026221RM8` | Международный код |

**Важно:** MOEX API требует использовать **SECID**, а не международный ISIN.

### Структура SECID для ОФЗ

```
SU26221RMFS0
││└────┬────┘│
││     │     └─ Суффикс (RMFS = рублёвые)
││     └─────── Номер выпуска (26221)
│└───────────── Тип (26 = ОФЗ-ПД)
└─────────────── Признак суверенных бумаг (SU = Russia)
```

---

## Торговые площадки

| Board ID | Описание |
|----------|----------|
| `TQOB` | Основной рынок ОФЗ |
| `TQCB` | Корпоративные облигации |
| `EQOB` | Основной рынок (акции) |

Для ОФЗ всегда используйте `TQOB`.

---

## График торгов

Торговая сессия ОФЗ (время московское):

| Период | Время |
|--------|-------|
| Премаркет | 06:50 - 07:00 |
| Основная сессия | 07:00 - 15:40 |
| Вечерняя сессия | 15:45 - 23:50 |

**Выходные:** суббота, воскресенье.

---

## Примеры использования

### Python (requests)

```python
import requests
from datetime import date, timedelta

# 10-минутные свечи
url = "https://iss.moex.com/iss/engines/stock/markets/bonds/boards/TQOB/securities/SU26221RMFS0/candles.json"

params = {
    'from': (date.today() - timedelta(days=7)).isoformat(),
    'till': date.today().isoformat(),
    'interval': '10',
    'iss.meta': 'off'
}

response = requests.get(url, params=params, timeout=30)
data = response.json()

columns = data['candles']['columns']
rows = data['candles']['data']

for row in rows:
    candle = dict(zip(columns, row))
    print(f"{candle['begin']}: close={candle['close']}%")
```

### cURL

```bash
curl "https://iss.moex.com/iss/engines/stock/markets/bonds/boards/TQOB/securities/SU26221RMFS0/candles.json?from=2026-02-01&till=2026-02-28&interval=10&iss.meta=off"
```

---

## Ограничения API

1. **Rate Limiting:** MOEX не публикует официальные лимиты, рекомендуется задержка 0.3-0.5 сек между запросами
2. **Пагинация:** Максимум 500 записей на запрос
3. **Timeout:** Рекомендуется 30 секунд

---

## Модули проекта

| Файл | Назначение |
|------|------------|
| `moex_candles.py` | Получение внутридневных свечей |
| `moex_history.py` | Исторические YTM (YIELDCLOSE) |
| `moex_bonds.py` | Список облигаций, рыночные данные |
| `moex_trading.py` | Проверка торгов |

---

*Обновлено: 01.03.2026*
